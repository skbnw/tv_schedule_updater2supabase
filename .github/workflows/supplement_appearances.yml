name: Supplement Appearances from JSON

on:
  schedule:
    - cron: '0 18 * * *'  # JST 3:00 = UTC 18:00
  workflow_dispatch:
    inputs:
      target_days_back:
        description: '過去何日分を処理するか（デフォルト: 3）'
        required: false
        type: string
        default: '3'

jobs:
  # 日付リストを生成するジョブ
  generate-dates:
    runs-on: ubuntu-latest
    outputs:
      dates: ${{ steps.set-dates.outputs.dates }}
    steps:
      - name: Generate date list
        id: set-dates
        run: |
          python3 << 'EOF'
          from datetime import datetime, timedelta
          import json
          import os
          
          days_back = int(os.environ.get('DAYS_BACK', '3'))
          dates = []
          today = datetime.now().date()
          
          for i in range(days_back):
              target_date = today - timedelta(days=i)
              dates.append(target_date.strftime('%Y-%m-%d'))
          
          dates_json = json.dumps(dates)
          print(f"Generated dates: {dates_json}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"dates={dates_json}\n")
          EOF
        env:
          DAYS_BACK: ${{ inputs.target_days_back || '3' }}

  # 日付ごとに並列処理（supplement_appearances_from_json.py）
  supplement-by-date:
    needs: generate-dates
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 各日付は2時間以内
    strategy:
      fail-fast: false
      matrix:
        date: ${{ fromJson(needs.generate-dates.outputs.dates) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run supplement script (by date)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TARGET_DATES: ${{ matrix.date }}
          MAX_PROGRAMS: '2000'  # 1日分なので削減
        run: |
          echo "Processing date: ${{ matrix.date }}"
          python supplement_appearances_from_json.py

  # 日付ごとに並列処理（update_supabase_storage.py）- 別ジョブとして分離
  update-storage-by-date:
    needs: generate-dates
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 各日付は2時間以内
    strategy:
      fail-fast: false
      matrix:
        date: ${{ fromJson(needs.generate-dates.outputs.dates) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run storage update script (by date)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TARGET_DATES: ${{ matrix.date }}
          MAX_FILES: '100'  # 1日分、Webスクレイピングのためさらに削減
        run: |
          echo "Processing date: ${{ matrix.date }}"
          python update_supabase_storage.py 